<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Custom Request • Anaya Reversed 3D Puzzles</title>
  <link rel="stylesheet" href="styles.css" />
</head>

<body class="catalog-body">
  <header class="site-header">
    <nav class="nav">
      <a href="index.html" class="brand">Anaya Reversed™ 3D Puzzles</a>
      <div class="nav-links">
        <a href="index.html">Home</a>
        <a href="catalog.html">Puzzles</a>
        <a href="designer.html">Designer</a>
        <a href="custom.html" aria-current="page">Custom Request</a>
        <a href="contact.html">Contact</a>
      </div>
    </nav>
  </header>

  <main class="catalog-section">
    <h1>Custom Request</h1>
    <p class="subtitle">We’ll use your Designer upload + options to pre-fill this form.</p>

    <div class="catalog-grid">
      <!-- LEFT: Preview -->
      <section class="product-card">
        <h3>1) Preview</h3>
        <p class="subtitle">Your uploaded image + estimate</p>

        <div id="previewWrap" style="margin-top: 0.75rem;">
          <img id="previewImg" alt="Uploaded image preview" style="max-width:100%; border-radius:12px; display:none;" />
          <div id="previewMissing" class="subtitle" style="opacity:.8;">
            No image loaded yet. Go back to the Designer and upload an image.
          </div>
        </div>

        <ul class="details" style="margin-top: 1rem;">
          <li><strong>Size:</strong> <span id="previewSize">—</span></li>
          <li><strong>Pieces:</strong> <span id="previewPieces">—</span></li>
          <li><strong>Add-ons:</strong> <span id="previewAddons">—</span></li>
        </ul>

        <div class="price" style="margin-top: 1rem;">
          Estimated Total: <span id="previewTotal">$—</span>
        </div>

        <div style="margin-top: 1rem;">
          <a class="btn" href="designer.html">Back to Designer</a>
        </div>
      </section>

      <!-- RIGHT: Form -->
      <section class="product-card">
        <h3>2) Your Info</h3>
        <p class="subtitle">Submit your request and I’ll follow up with final confirmation.</p>

        <form id="requestForm">
          <!-- REQUIRED hidden fields for your pipeline -->
          <input type="hidden" id="imageUrl" name="imageUrl" />
          <input type="hidden" id="size" name="size" />
          <input type="hidden" id="pieces" name="pieces" value="100" />
          <input type="hidden" id="total" name="total" />
          <input type="hidden" id="addons" name="addons" />

          <label style="display:block; margin-top: 0.75rem;">
            <div class="subtitle">Name</div>
            <input id="name" name="name" type="text" required style="width:100%; padding:.6rem; border-radius:10px;">
          </label>

          <label style="display:block; margin-top: 0.75rem;">
            <div class="subtitle">Email</div>
            <input id="email" name="email" type="email" required style="width:100%; padding:.6rem; border-radius:10px;">
          </label>

          <label style="display:block; margin-top: 0.75rem;">
            <div class="subtitle">Phone (optional)</div>
            <input id="phone" name="phone" type="tel" style="width:100%; padding:.6rem; border-radius:10px;">
          </label>

          <label style="display:block; margin-top: 0.75rem;">
            <div class="subtitle">Notes (optional)</div>
            <textarea id="notes" name="notes" rows="4" style="width:100%; padding:.6rem; border-radius:10px;"></textarea>
          </label>

          <div id="formStatus" class="subtitle" style="margin-top: .9rem; opacity:.9;"></div>

          <button id="submitBtn" class="btn" type="button">Submit Request</button>

        </form>

        <p class="subtitle" style="margin-top: 1rem; opacity:.75;">
          By submitting, you confirm you own the rights to the image or have permission to use it.
        </p>
      </section>
    </div>
  </main>

  <script>
    // Custom Request page: reads the saved draft from designer.html and submits to Netlify Function -> Google Apps Script
    const $ = (id) => document.getElementById(id);

    function loadDraft() {
      const keys = ["puzzleRequest", "puzzle_request", "puzzleDraft", "puzzle_draft"];
      for (const k of keys) {
        const raw = localStorage.getItem(k);
        if (!raw) continue;
        try { return JSON.parse(raw); } catch (e) {}
      }
      return null;
    }

    function money(n) {
      const num = Number(n);
      if (!Number.isFinite(num)) return "";
      return "$" + num.toFixed(0);
    }

    const draft = loadDraft();

    // Populate preview + hidden fields
    if (draft && draft.imageUrl) {
      const img = document.createElement("img");
      img.src = draft.imageUrl;
      img.alt = "Uploaded image preview";
      img.style.maxWidth = "220px";
      img.style.borderRadius = "12px";
      img.style.border = "1px solid rgba(255,255,255,.18)";
      img.style.display = "block";
      img.style.marginTop = "0.75rem";
      $("previewWrap").appendChild(img);

      $("previewHint").textContent = "";
      $("previewSize").textContent = draft.sizeLabel || draft.size || draft.sizeValue || "—";
      $("previewPieces").textContent = String(draft.pieces || "—");
      $("previewAddons").textContent = (draft.addons && draft.addons.length) ? draft.addons.join(", ") : "—";
      $("previewTotal").textContent = draft.total ? money(draft.total) : "—";

      // Hidden fields that get POSTed
      $("imageUrl").value = draft.imageUrl || "";
      $("size").value = draft.sizeLabel || draft.size || draft.sizeValue || "";
      $("pieces").value = String(draft.pieces || "");
      $("addons").value = JSON.stringify(draft.addons || []);
      $("total").value = String(draft.total || "");
      $("width").value = String(draft.width || "");
      $("height").value = String(draft.height || "");
      $("format").value = String(draft.format || "");
    } else {
      $("previewHint").textContent = "No image loaded yet. Go back to the Designer and upload an image.";
    }

    // Submit handler
    $("requestForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      const payload = {
        name: $("name").value.trim(),
        email: $("email").value.trim(),
        phone: $("phone").value.trim(),
        notes: $("notes").value.trim(),
        size: $("size").value.trim(),
        pieces: $("pieces").value.trim(),
        total: $("total").value.trim(),
        imageUrl: $("imageUrl").value.trim(),
        addons: (() => { try { return JSON.parse($("addons").value || "[]"); } catch { return []; } })(),
        width: $("width").value.trim(),
        height: $("height").value.trim(),
        format: $("format").value.trim(),
      };

      // Basic required fields (matches submit.js requirements)
      const missing = [];
      if (!payload.name) missing.push("name");
      if (!payload.email) missing.push("email");
      if (!payload.size) missing.push("size");
      if (!payload.pieces) missing.push("pieces");
      if (!payload.total) missing.push("total");
      if (!payload.imageUrl) missing.push("imageUrl");

      const statusEl = $("formStatus");
      if (missing.length) {
        statusEl.textContent = `❌ Missing: ${missing.join(", ")}. (Go back to Designer if size/pieces/total didn't carry over.)`;
        return;
      }

      statusEl.textContent = "⏳ Submitting…";

      try {
        const res = await fetch("/.netlify/functions/submit", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        const text = await res.text();
        let body;
        try { body = JSON.parse(text); } catch { body = { raw: text }; }

        if (!res.ok) {
          statusEl.textContent = `❌ Submit failed: ${res.status} • ${body.error || body.raw || "Unknown error"}`;
          return;
        }

        statusEl.textContent = "✅ Submitted! Your request was sent to the Google Sheet.";
        // Optional: clear draft so repeat submits don't happen accidentally
        // localStorage.removeItem("puzzleRequest");
      } catch (err) {
        statusEl.textContent = `❌ Submit failed: ${err.message || err}`;
      }
    });
  </script>
<script>
(function () {
  const form = document.getElementById("requestForm");
  const submitBtn = document.getElementById("submitBtn");
  const statusEl = document.getElementById("formStatus");

  if (!form || !submitBtn || !statusEl) {
    console.error("Missing required elements:", { form, submitBtn, statusEl });
    return;
  }

  // IMPORTANT: stop the browser from reloading the page
  form.addEventListener("submit", (e) => e.preventDefault());

  submitBtn.addEventListener("click", async (e) => {
    e.preventDefault();

    statusEl.textContent = "Submitting…";
    statusEl.style.color = "#ddd";
    submitBtn.disabled = true;

    try {
      // pull the draft you saved from Designer (adjust key if yours differs)
      const draftRaw = localStorage.getItem("puzzleRequestDraft") || "{}";
      const draft = JSON.parse(draftRaw);

      // build payload from form + draft
      const payload = {
        name: (document.getElementById("name")?.value || "").trim(),
        email: (document.getElementById("email")?.value || "").trim(),
        phone: (document.getElementById("phone")?.value || "").trim(),
        notes: (document.getElementById("notes")?.value || "").trim(),

        // these usually come from the Designer draft
        size: draft.size || "",
        pieces: draft.pieces || "",
        addons: draft.addons || {},
        total: draft.total || "",
        imageUrl: draft.imageUrl || "",
        width: draft.width || "",
        height: draft.height || "",
        format: draft.format || "",
      };

      // quick client-side validation so it doesn’t silently fail
      const missing = [];
      ["name","email","size","pieces","total","imageUrl"].forEach(k => {
        if (!payload[k] || (typeof payload[k] === "string" && payload[k].trim() === "")) missing.push(k);
      });
      if (missing.length) {
        throw new Error("Missing required fields: " + missing.join(", "));
      }

      const res = await fetch("/.netlify/functions/submit", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });

      const text = await res.text();
      if (!res.ok) throw new Error(`Submit failed ${res.status}: ${text}`);

      // Only clear AFTER success
      localStorage.removeItem("puzzleRequestDraft");

      statusEl.textContent = "✅ Request submitted! Check your Google Sheet.";
      statusEl.style.color = "#7CFC98";
      form.reset();

    } catch (err) {
      console.error(err);
      statusEl.textContent = "❌ " + (err?.message || "Unknown error");
      statusEl.style.color = "#ff6b6b";
    } finally {
      submitBtn.disabled = false;
    }
  });
})();
</script>


</body>
</html>
