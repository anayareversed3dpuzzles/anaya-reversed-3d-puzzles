<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Designer | Anaya Reversed 3D Puzzles</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body class="catalog-body">

<header>
  <div class="logo">
    <img src="images/bizlogo.png" alt="Anaya Reversed Logo">
  </div>
  <nav>
    <a href="index.html">Home</a>
    <a href="catalog.html">Puzzles</a>
    <a href="designer.html">Designer</a>
    <a href="custom.html">Custom Request</a>
    <a href="contact.html">Contact</a>
  </nav>
</header>

<section class="catalog-section">
  <h1>Puzzle Designer</h1>
  <p class="catalog-intro">Upload an image to get a fast estimate and start a custom request.</p>

  <div class="catalog-grid">
    <div class="product-card">
      <h3>1) Upload Your Image</h3>
      <p class="subtitle">Secure signed upload (no accounts needed)</p>

      <ul class="details">
        <li><strong>Accepted:</strong> JPG, PNG</li>
        <li><strong>Recommended:</strong> 2000px+ shortest side</li>
        <li><strong>Avoid:</strong> blurry, dark, low-res screenshots</li>
      </ul>

      <button id="uploadBtn" class="btn" type="button">Upload Image</button>

      <div id="uploadStatus" class="subtitle" style="margin-top: 0.8rem;"></div>
      <div id="uploadedUrl" style="word-break: break-word; font-size: 0.8rem; opacity: 0.85;"></div>
      <div
        id="imageQualityWarning"
        style="margin-top: 0.4rem; font-size: 0.9rem;"
></div>
    <div class="field" style="margin-top: 0.8rem;">
      <label for="sizeSelect" class="subtitle" style="display:block; margin-bottom:0.35rem;">Size</label>
      <select id="sizeSelect" class="select">
        <option value="150x150_100">150×150 (100 pcs)</option>
        <option value="175x175_100">175×175 (100 pcs)</option>
      </select>
    </div>

    <div class="field" style="margin-top: 0.8rem;">
      <div class="subtitle" style="margin-bottom:0.35rem;">Add-ons</div>
      <label class="checkbox"><input type="checkbox" id="addonMulticolor"> Multi-color (+$5)</label><br>
      <label class="checkbox"><input type="checkbox" id="addonCleanup"> Image cleanup (+$15)</label><br>
      <label class="checkbox"><input type="checkbox" id="addonRush"> Rush (+$15)</label>
    </div>


    </div>

    <div class="product-card">
      <h3>2) Quote Preview</h3>
      <p class="subtitle">We’ll add the pricing algorithm next</p>

      <ul class="details">
        <li><strong>150×150 (100 pcs):</strong> $38</li>
        <li><strong>175×175 (100 pcs):</strong> $60</li>
      </ul>

      <div class="price" id="priceDisplay">$38</div>

      <div id="priceBreakdown" style="margin-top:0.5rem; font-size:0.95rem; opacity:0.9;"></div>

      <a class="btn" id="continueBtn" href="custom.html">Continue to Request Form</a>
    </div>
  </div>
</section>

<!-- Cloudinary Upload Widget (loads from Cloudinary) -->
<script src="https://widget.cloudinary.com/v2.0/global/all.js">
  // Cloudinary Upload Widget + Signed Upload (Netlify Function)
  let uploadedImage = null;

  // ---- Pricing (edit anytime) ----
  const BASE_PRICES = {
    "150x150_100": 38,
    "175x175_100": 60,
  };
  const ADDON_PRICES = {
    multicolor: 5,
    cleanup: 15,
    rush: 15,
  };

  function getSelections() {
    const size = document.getElementById("sizeSelect")?.value || "150x150_100";
    const addons = {
      multicolor: !!document.getElementById("addonMulticolor")?.checked,
      cleanup: !!document.getElementById("addonCleanup")?.checked,
      rush: !!document.getElementById("addonRush")?.checked,
    };
    return { size, addons };
  }

  function computeTotal({ size, addons }) {
    const base = BASE_PRICES[size] ?? 0;
    const addonTotal =
      (addons.multicolor ? ADDON_PRICES.multicolor : 0) +
      (addons.cleanup ? ADDON_PRICES.cleanup : 0) +
      (addons.rush ? ADDON_PRICES.rush : 0);
    return { base, addonTotal, total: base + addonTotal };
  }

  function updateQuoteUI() {
    const priceEl = document.getElementById("priceDisplay");
    const breakdownEl = document.getElementById("priceBreakdown");
    if (!priceEl) return;

    const selections = getSelections();
    const { base, addonTotal, total } = computeTotal(selections);

    priceEl.textContent = `$${total}`;

    if (breakdownEl) {
      const parts = [`Base: $${base}`];
      if (selections.addons.multicolor) parts.push(`Multi-color: +$${ADDON_PRICES.multicolor}`);
      if (selections.addons.cleanup) parts.push(`Image cleanup: +$${ADDON_PRICES.cleanup}`);
      if (selections.addons.rush) parts.push(`Rush: +$${ADDON_PRICES.rush}`);
      if (addonTotal > 0) parts.push(`Add-ons subtotal: $${addonTotal}`);
      breakdownEl.textContent = parts.join(" • ");
    }
  }

  // Keep quote updated when user changes options
  ["sizeSelect", "addonMulticolor", "addonCleanup", "addonRush"].forEach((id) => {
    const el = document.getElementById(id);
    if (el) el.addEventListener("change", updateQuoteUI);
  });
  updateQuoteUI();

  async function getSignature() {
    const res = await fetch("/.netlify/functions/cloudinary-sign", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ folder: "puzzle-requests" }),
    });

    if (!res.ok) {
      const txt = await res.text().catch(() => "");
      throw new Error(`Failed to get upload signature (${res.status}): ${txt}`);
    }
    return res.json();
  }

  function setQualityMessage(info) {
    const qualityEl = document.getElementById("imageQualityWarning");
    if (!qualityEl || !info) return;

    const minSize = 1200;
    const w = Number(info.width || 0);
    const h = Number(info.height || 0);
    const shortestSide = Math.min(w, h);

    if (!w || !h) {
      qualityEl.textContent = "";
      return;
    }

    if (shortestSide < minSize) {
      qualityEl.textContent = `⚠️ Low resolution (${w}×${h}). Minimum is ${minSize}px on shortest side.`;
      qualityEl.style.color = "#b45309";
    } else {
      qualityEl.textContent = "✅ Image resolution looks good for printing.";
      qualityEl.style.color = "#15803d";
    }
  }

  async function openUploadWidget() {
    const statusEl = document.getElementById("uploadStatus");
    const urlEl = document.getElementById("uploadedUrl");
    if (statusEl) statusEl.textContent = "Preparing secure upload…";
    if (urlEl) urlEl.textContent = "";
    setQualityMessage(null);

    const sig = await getSignature();

    const widget = cloudinary.createUploadWidget(
      {
        cloudName: sig.cloudName,
        apiKey: sig.apiKey,
        folder: sig.folder,

        // Signed upload fields
        uploadSignatureTimestamp: sig.timestamp,
        uploadSignature: sig.signature,

        // Client-side restrictions
        sources: ["local", "camera"],
        multiple: false,
        resourceType: "image",
        clientAllowedFormats: ["png", "jpg", "jpeg"],
        maxFileSize: 8 * 1024 * 1024, // 8MB
      },
      (error, result) => {
        if (error) {
          if (statusEl) statusEl.textContent = "Upload failed. Try again.";
          console.error("Cloudinary widget error:", error);
          return;
        }

        if (result && result.event === "success") {
          uploadedImage = {
            url: result.info.secure_url,
            width: result.info.width,
            height: result.info.height,
            format: result.info.format,
            public_id: result.info.public_id,
          };

          if (statusEl) statusEl.textContent = "Upload complete ✅";
          if (urlEl) urlEl.textContent = uploadedImage.url;

          setQualityMessage(uploadedImage);

          // Optional: keep it for the next page
          sessionStorage.setItem("uploadedImage", JSON.stringify(uploadedImage));
        }
      }
    );

    if (statusEl) statusEl.textContent = "Open upload window…";
    widget.open();
  }

  // Upload button
  const uploadBtn = document.getElementById("uploadBtn");
  if (uploadBtn) {
    uploadBtn.addEventListener("click", () => {
      openUploadWidget().catch((err) => {
        console.error(err);
        const statusEl = document.getElementById("uploadStatus");
        if (statusEl) statusEl.textContent = `Error: ${err.message}`;
      });
    });
  }

  // Continue button: store selections and go to custom.html
  const continueBtn = document.getElementById("continueBtn");
  if (continueBtn) {
    continueBtn.addEventListener("click", (e) => {
      e.preventDefault();

      if (!uploadedImage) {
        const saved = sessionStorage.getItem("uploadedImage");
        if (saved) {
          try { uploadedImage = JSON.parse(saved); } catch {}
        }
      }

      if (!uploadedImage) {
        alert("Please upload an image first.");
        return;
      }

      const selections = getSelections();
      const pricing = computeTotal(selections);

      const payload = {
        uploadedImage,
        size: selections.size,
        addons: selections.addons,
        pricing,
      };

      sessionStorage.setItem("puzzleRequestDraft", JSON.stringify(payload));

      window.location.href = "custom.html";
    });
  }
</script>
<script>
  // Cloudinary Upload Widget + Signed Upload (Netlify Function)
  let uploadedImage = null;

  async function getSignature() {
    const res = await fetch("/.netlify/functions/cloudinary-sign", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ folder: "puzzle-requests" }),
    });

    if (!res.ok) {
      const txt = await res.text().catch(() => "");
      throw new Error(`Failed to get upload signature (${res.status}): ${txt}`);
    }
    return res.json();
  }

  function setQualityMessage(info) {
    const qualityEl = document.getElementById("imageQualityWarning");
    if (!qualityEl || !info) return;

    const minSize = 1200;
    const w = Number(info.width || 0);
    const h = Number(info.height || 0);
    const shortestSide = Math.min(w, h);

    if (!w || !h) {
      qualityEl.textContent = "";
      return;
    }

    if (shortestSide < minSize) {
      qualityEl.textContent = `⚠️ Low resolution (${w}×${h}). Minimum is ${minSize}px on shortest side.`;
      qualityEl.style.color = "#b45309";
    } else {
      qualityEl.textContent = "✅ Image resolution looks good for printing.";
      qualityEl.style.color = "#15803d";
    }
  }

  async function openUploadWidget() {
    const statusEl = document.getElementById("uploadStatus");
    const urlEl = document.getElementById("uploadedUrl");
    if (statusEl) statusEl.textContent = "Preparing secure upload…";
    if (urlEl) urlEl.textContent = "";
    setQualityMessage(null);

    const sig = await getSignature();

    const widget = cloudinary.createUploadWidget(
      {
        cloudName: sig.cloudName,
        apiKey: sig.apiKey,
        folder: sig.folder,

        // Signed upload fields
        uploadSignatureTimestamp: sig.timestamp,
        uploadSignature: sig.signature,

        // Client-side restrictions
        sources: ["local", "camera"],
        multiple: false,
        resourceType: "image",
        clientAllowedFormats: ["png", "jpg", "jpeg"],
        maxFileSize: 8 * 1024 * 1024, // 8MB
      },
      (error, result) => {
        if (error) {
          if (statusEl) statusEl.textContent = "Upload failed. Try again.";
          console.error("Cloudinary widget error:", error);
          return;
        }

        if (result && result.event === "success") {
          uploadedImage = {
            url: result.info.secure_url,
            width: result.info.width,
            height: result.info.height,
            format: result.info.format,
            public_id: result.info.public_id,
          };

          if (statusEl) statusEl.textContent = "Upload complete ✅";
          if (urlEl) urlEl.textContent = uploadedImage.url;

          setQualityMessage(uploadedImage);

          // Optional: keep it for the next page
          sessionStorage.setItem("uploadedImage", JSON.stringify(uploadedImage));
        }
      }
    );

    if (statusEl) statusEl.textContent = "Open upload window…";
    widget.open();
  }

  // Upload button
  const uploadBtn = document.getElementById("uploadBtn");
  if (uploadBtn) {
    uploadBtn.addEventListener("click", () => {
      openUploadWidget().catch((err) => {
        console.error(err);
        const statusEl = document.getElementById("uploadStatus");
        if (statusEl) statusEl.textContent = `Error: ${err.message}`;
      });
    });
  }

  // Continue button: store selections and go to custom.html
  const continueBtn = document.getElementById("continueBtn");
  if (continueBtn) {
    continueBtn.addEventListener("click", (e) => {
      // If you want the link to always work, comment out the next line.
      e.preventDefault();

      if (!uploadedImage) {
        // Try to restore from sessionStorage if page refreshed
        const saved = sessionStorage.getItem("uploadedImage");
        if (saved) {
          try { uploadedImage = JSON.parse(saved); } catch {}
        }
      }

      if (!uploadedImage) {
        alert("Please upload an image first.");
        return;
      }

      const sizeEl = document.getElementById("sizeSelect");
      const size = sizeEl ? sizeEl.value : "";

      const addons = {
        multicolor: !!document.getElementById("addonMulticolor")?.checked,
        cleanup: !!document.getElementById("addonCleanup")?.checked,
        rush: !!document.getElementById("addonRush")?.checked,
      };

      const payload = {
        uploadedImage,
        size,
        addons,
      };

      sessionStorage.setItem("puzzleRequestDraft", JSON.stringify(payload));

      window.location.href = "custom.html";
    });
  }
</script>
</body>
</html>





