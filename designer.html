<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Designer | Anaya Reversed 3D Puzzles</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body class="catalog-body">

<header>
  <div class="logo">
    <img src="images/bizlogo.png" alt="Anaya Reversed Logo">
  </div>
  <nav>
    <a href="index.html">Home</a>
    <a href="catalog.html">Puzzles</a>
    <a href="designer.html">Designer</a>
    <a href="custom.html">Custom Request</a>
    <a href="contact.html">Contact</a>
  </nav>
</header>

<section class="catalog-section">
  <h1>Puzzle Designer</h1>
  <p class="catalog-intro">Upload an image to get a fast estimate and start a custom request.</p>

  <div class="catalog-grid">
    <div class="product-card">
      <h3>1) Upload Your Image</h3>
      <p class="subtitle">Secure signed upload (no accounts needed)</p>

      <ul class="details">
        <li><strong>Accepted:</strong> JPG, PNG</li>
        <li><strong>Recommended:</strong> 2000px+ shortest side</li>
        <li><strong>Avoid:</strong> blurry, dark, low-res screenshots</li>
      </ul>

      <button id="uploadBtn" class="btn" type="button">Upload Image</button>

      <div id="uploadStatus" class="subtitle" style="margin-top: 0.8rem;"></div>
      <div id="uploadedUrl" style="word-break: break-word; font-size: 0.8rem; opacity: 0.85;"></div>
      <div
        id="imageQualityWarning"
        style="margin-top: 0.4rem; font-size: 0.9rem;"
></div>

    </div>

    <div class="product-card">
      <h3>2) Quote Preview</h3>
      <p class="subtitle">We’ll add the pricing algorithm next</p>

      <ul class="details">
        <li><strong>150×150 (100 pcs):</strong> $38</li>
        <li><strong>175×175 (100 pcs):</strong> $60</li>
      </ul>

      <div class="price" id="priceDisplay">$38</div>

      <div id="priceBreakdown" style="margin-top:0.5rem; font-size:0.95rem; opacity:0.9;"></div>

      <a class="btn" href="custom.html">Continue to Request Form</a>
    </div>
  </div>
</section>

<!-- Cloudinary Upload Widget (loads from Cloudinary) -->
<script src="https://widget.cloudinary.com/v2.0/global/all.js"></script>
<script>
  let uploadedImage = null;

  async function getSignature() {
    const res = await fetch("/.netlify/functions/cloudinary-sign", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ folder: "puzzle-requests" })
    });

    if (!res.ok) throw new Error("Failed to get upload signature");
    return res.json();
  }

  async function openUploadWidget() {
    const statusEl = document.getElementById("uploadStatus");
    const urlEl = document.getElementById("uploadedUrl");

    statusEl.textContent = "Preparing secure upload…";
    urlEl.textContent = "";

    const sig = await getSignature();

    const widget = cloudinary.createUploadWidget({
      cloudName: sig.cloudName,
      apiKey: sig.apiKey,
      folder: sig.folder,

      // Important: signed upload
      uploadSignatureTimestamp: sig.timestamp,
      uploadSignature: sig.signature,

      // restrictions (client-side)
      sources: ["local", "camera"],
      multiple: false,
      resourceType: "image",
      clientAllowedFormats: ["png", "jpg", "jpeg"],
      maxFileSize: 8 * 1024 * 1024, // 8MB
    }, (error, result) => {
      if (error) {
        statusEl.textContent = "Upload failed. Try again.";
        return;
      }
      if (result && result.event === "success") {
        uploadedImage = {
        url: result.info.secure_url,
        width: result.info.width,
        height: result.info.height,
        format: result.info.format
      };

      statusEl.textContent = "Upload complete ✅";
      urlEl.textContent = uploadedImage.url;

      console.log("Uploaded image:", uploadedImage);

      // ✅ STEP 2 — IMAGE QUALITY CHECK
const minSize = 1200;
const shortestSide = Math.min(uploadedImage.width, uploadedImage.height);
const qualityEl = document.getElementById("imageQualityWarning");

if (shortestSide < minSize) {
  qualityEl.textContent =
    `⚠️ Low resolution (${uploadedImage.width}×${uploadedImage.height}). ` +
    `Minimum is ${minSize}px on the shortest side.`;
  qualityEl.style.color = "#b45309";
} else {
  qualityEl.textContent = "✅ Image resolution looks good for printing.";
  qualityEl.style.color = "#15803d";
}      
  }
    });

    statusEl.textContent = "Open upload window…";
    widget.open();
  }

  document.getElementById("uploadBtn").addEventListener("click", () => {
    openUploadWidget().catch(err => {
      document.getElementById("uploadStatus").textContent = "Error: " + err.message;
    });
  });
</script>
</body>
</html>

