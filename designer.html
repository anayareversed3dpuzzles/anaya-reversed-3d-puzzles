<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Designer | Anaya Reversed 3D Puzzles</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body class="catalog-body">

<header>
  <div class="logo">
    <img src="images/bizlogo.png" alt="Anaya Reversed Logo">
  </div>
  <nav>
    <a href="index.html">Home</a>
    <a href="catalog.html">Puzzles</a>
    <a href="designer.html">Designer</a>
    <a href="custom.html">Custom Request</a>
    <a href="contact.html">Contact</a>
  </nav>
</header>

<section class="catalog-section">
  <h1>Puzzle Designer</h1>
  <p class="catalog-intro">Upload an image to get a fast estimate and start a custom request.</p>

  <div class="catalog-grid">
    <div class="product-card">
      <h3>1) Upload Your Image</h3>
      <p class="subtitle">Secure signed upload (no accounts needed)</p>

      <ul class="details">
        <li><strong>Accepted:</strong> JPG, PNG</li>
        <li><strong>Recommended:</strong> 2000px+ shortest side</li>
        <li><strong>Avoid:</strong> blurry, dark, low-res screenshots</li>
      </ul>

      <button id="uploadBtn" class="btn" type="button">Upload Image</button>

      <div id="uploadStatus" class="subtitle" style="margin-top: 0.8rem;"></div>
      <div id="uploadedUrl" style="word-break: break-word; font-size: 0.8rem; opacity: 0.85;"></div>
    </div>

    <div class="product-card">
      <label class="subtitle">Size</label>
<select id="sizeSelect" class="btn" style="text-transform:none; letter-spacing:0; padding:0.55rem 0.9rem;">
  <option value="100">100×100 (100 pcs)</option>
  <option value="150">150×150 (100 pcs)</option>
</select>

<div style="height:0.8rem;"></div>

<label class="subtitle">Add-ons</label>
<div style="display:flex; flex-direction:column; gap:0.4rem; font-size:0.85rem;">
  <label><input type="checkbox" id="addonMulticolor"> Multi-color (+$5)</label>
  <label><input type="checkbox" id="addonCleanup"> Image cleanup (+$15)</label>
  <label><input type="checkbox" id="addonRush"> Rush (+$15)</label>
</div>

<div id="quoteNotes" class="subtitle" style="margin-top:0.8rem;"></div>
<div class="price" id="quoteTotal">$—</div>

<div id="quoteBreakdown" style="font-size:0.85rem; opacity:0.9; margin-top:0.5rem;"></div>

    </div>
  </div>
</section>

<!-- Cloudinary Upload Widget (loads from Cloudinary) -->
<script src="https://widget.cloudinary.com/v2.0/global/all.js"></script>
<script>
  let uploadedImageInfo = null;

  async function getSignature() {
    const res = await fetch("/.netlify/functions/cloudinary-sign", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ folder: "puzzle-requests" })
    });
    if (!res.ok) throw new Error("Failed to get upload signature");
    return res.json();
  }

  async function fetchQuote() {
    const size = document.getElementById("sizeSelect").value;

    const payload = {
      size,
      pieces: 100,
      addons: {
        multicolor: document.getElementById("addonMulticolor").checked,
        cleanup: document.getElementById("addonCleanup").checked,
        rush: document.getElementById("addonRush").checked,
      },
      // If user uploaded, pass Cloudinary metadata for quality checks
      image: uploadedImageInfo ? {
        format: uploadedImageInfo.format,
        width: uploadedImageInfo.width,
        height: uploadedImageInfo.height
      } : {}
    };

    const res = await fetch("/.netlify/functions/quote", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const data = await res.json();
    if (!res.ok) throw new Error(data.error || "Quote failed");

    renderQuote(data);
  }

  function renderQuote(data) {
    document.getElementById("quoteTotal").textContent = `$${data.total}`;

    const notes = (data.notes || []).join("<br>");
    document.getElementById("quoteNotes").innerHTML = notes;

    const breakdownHtml = (data.breakdown || [])
      .map(item => `<div style="display:flex; justify-content:space-between; gap:1rem;">
          <span>${item.label}</span><span>$${item.amount}</span>
        </div>`)
      .join("");

    document.getElementById("quoteBreakdown").innerHTML = breakdownHtml;
  }

  async function openUploadWidget() {
    const statusEl = document.getElementById("uploadStatus");
    const urlEl = document.getElementById("uploadedUrl");

    statusEl.textContent = "Preparing secure upload…";
    urlEl.textContent = "";

    const sig = await getSignature();

    const widget = cloudinary.createUploadWidget({
      cloudName: sig.cloudName,
      apiKey: sig.apiKey,
      folder: sig.folder,
      uploadSignatureTimestamp: sig.timestamp,
      uploadSignature: sig.signature,

      sources: ["local", "camera"],
      multiple: false,
      resourceType: "image",
      clientAllowedFormats: ["png", "jpg", "jpeg"],
      maxFileSize: 8 * 1024 * 1024
    }, async (error, result) => {
      if (error) {
        statusEl.textContent = "Upload failed. Try again.";
        return;
      }
      if (result && result.event === "success") {
        uploadedImageInfo = result.info;
        statusEl.textContent = "Upload complete ✅";
        urlEl.textContent = result.info.secure_url;

        // Refresh quote to show image quality notes
        try { await fetchQuote(); } catch (e) {}
      }
    });

    widget.open();
  }

  // Wire events
  document.getElementById("uploadBtn").addEventListener("click", () => {
    openUploadWidget().catch(err => {
      document.getElementById("uploadStatus").textContent = "Error: " + err.message;
    });
  });

  ["sizeSelect","addonMulticolor","addonCleanup","addonRush"].forEach(id => {
    document.getElementById(id).addEventListener("change", () => {
      fetchQuote().catch(err => {
        document.getElementById("quoteNotes").textContent = "Error: " + err.message;
      });
    });
  });

  // Initial quote load (no image yet)
  fetchQuote().catch(() => {});
</script>

</body>
</html>


