<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Designer | Anaya Reversed 3D Puzzles</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body class="catalog-body">

<header>
  <div class="logo">
    <img src="images/bizlogo.png" alt="Anaya Reversed Logo">
  </div>
  <nav>
    <a href="index.html">Home</a>
    <a href="catalog.html">Puzzles</a>
    <a href="designer.html">Designer</a>
    <a href="custom.html">Custom Request</a>
    <a href="contact.html">Contact</a>
  </nav>
</header>

<section class="catalog-section">
  <h1>Puzzle Designer</h1>
  <p class="catalog-intro">Upload an image to get a fast estimate and start a custom request.</p>

  <div class="catalog-grid">
    <div class="product-card">
      <h3>1) Upload Your Image</h3>
      <p class="subtitle">Secure signed upload (no accounts needed)</p>

      <ul class="details">
        <li><strong>Accepted:</strong> JPG, PNG</li>
        <li><strong>Recommended:</strong> 2000px+ shortest side</li>
        <li><strong>Avoid:</strong> blurry, dark, low-res screenshots</li>
      </ul>

      <button id="uploadBtn" class="btn" type="button">Upload Image</button>

      <div id="uploadStatus" class="subtitle" style="margin-top: 0.8rem;"></div>
      <div id="uploadedUrl" style="word-break: break-word; font-size: 0.8rem; opacity: 0.85;"></div>
      <div
        id="imageQualityWarning"
        style="margin-top: 0.4rem; font-size: 0.9rem;"
></div>

    </div>

    <div class="product-card">
      <h3>2) Quote Preview</h3>
      <p class="subtitle">We’ll add the pricing algorithm next</p>

      <ul class="details">
        <li><strong>150×150 (100 pcs):</strong> $38</li>
        <li><strong>175×175 (100 pcs):</strong> $60</li>
      </ul>

	  <div style="margin-top:0.8rem;">
	    <label for="sizeSelect" class="subtitle" style="display:block; margin-bottom:0.35rem;">Size</label>
	    <select id="sizeSelect" class="input" style="max-width: 260px;">
	      <option value="150x150_100">150×150 (100 pcs)</option>
	      <option value="175x175_100">175×175 (100 pcs)</option>
	    </select>
	  </div>

	  <div style="margin-top:0.9rem;">
	    <div class="subtitle" style="margin-bottom:0.35rem;">Add-ons</div>
	    <label style="display:block; margin:0.3rem 0;"><input type="checkbox" id="addonMulticolor" /> Multi-color (+$5)</label>
	    <label style="display:block; margin:0.3rem 0;"><input type="checkbox" id="addonCleanup" /> Image cleanup (+$15)</label>
	    <label style="display:block; margin:0.3rem 0;"><input type="checkbox" id="addonRush" /> Rush (+$15)</label>
	  </div>

      <div class="price" id="priceDisplay">$38</div>

      <div id="priceBreakdown" style="margin-top:0.5rem; font-size:0.95rem; opacity:0.9;"></div>

      <a class="btn" id="continueBtn" href="custom.html">Continue to Request Form</a>
    </div>
  </div>
</section>

<!-- Cloudinary Upload Widget (loads from Cloudinary) -->
<script src="https://widget.cloudinary.com/v2.0/global/all.js"></script>
	<script>
	  let uploadedImage = null;
	  const sizeSelect = document.getElementById("sizeSelect");
	  const addonMulticolor = document.getElementById("addonMulticolor");
	  const addonCleanup = document.getElementById("addonCleanup");
	  const addonRush = document.getElementById("addonRush");
	  const priceDisplay = document.getElementById("priceDisplay");
	  const priceBreakdown = document.getElementById("priceBreakdown");

	  const BASE_PRICES = {
	    "150x150_100": 38,
	    "175x175_100": 60,
	  };

	  function selectedAddons() {
	    const addons = [];
	    if (addonMulticolor?.checked) addons.push({ name: "Multi-color", price: 5 });
	    if (addonCleanup?.checked) addons.push({ name: "Image cleanup", price: 15 });
	    if (addonRush?.checked) addons.push({ name: "Rush", price: 15 });
	    return addons;
	  }

	  function parsePieces(sizeKey) {
	    // sizeKey format: 150x150_100
	    const m = String(sizeKey || "").match(/_(\d+)$/);
	    return m ? Number(m[1]) : 100;
	  }

	  function prettySize(sizeKey) {
	    const map = {
	      "150x150_100": "150×150 (100 pcs)",
	      "175x175_100": "175×175 (100 pcs)",
	    };
	    return map[sizeKey] || sizeKey;
	  }

	  function updatePriceUI() {
	    const sizeKey = sizeSelect?.value || "150x150_100";
	    const base = BASE_PRICES[sizeKey] ?? 0;
	    const addons = selectedAddons();
	    const addonsTotal = addons.reduce((sum, a) => sum + a.price, 0);
	    const total = base + addonsTotal;

	    if (priceDisplay) priceDisplay.textContent = `$${total}`;
	    if (priceBreakdown) {
	      const lines = [`Base (${prettySize(sizeKey)}): $${base}`]
	        .concat(addons.map(a => `${a.name}: +$${a.price}`))
	        .concat([`Total: $${total}`]);
	      priceBreakdown.textContent = lines.join("\n");
	      priceBreakdown.style.whiteSpace = "pre-line";
	    }
	  }

  async function getSignature() {
    const res = await fetch("/.netlify/functions/cloudinary-sign", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ folder: "puzzle-requests" })
    });

    if (!res.ok) throw new Error("Failed to get upload signature");
    return res.json();
  }

  async function openUploadWidget() {
    const statusEl = document.getElementById("uploadStatus");
    const urlEl = document.getElementById("uploadedUrl");

    statusEl.textContent = "Preparing secure upload…";
    urlEl.textContent = "";

    const sig = await getSignature();

    const widget = cloudinary.createUploadWidget({
      cloudName: sig.cloudName,
      apiKey: sig.apiKey,
      folder: sig.folder,

      // Important: signed upload
      uploadSignatureTimestamp: sig.timestamp,
      uploadSignature: sig.signature,

      // restrictions (client-side)
      sources: ["local", "camera"],
      multiple: false,
      resourceType: "image",
      clientAllowedFormats: ["png", "jpg", "jpeg"],
      maxFileSize: 8 * 1024 * 1024, // 8MB
    }, (error, result) => {
      if (error) {
        statusEl.textContent = "Upload failed. Try again.";
        return;
      }
      if (result && result.event === "success") {
        uploadedImage = {
        url: result.info.secure_url,
        width: result.info.width,
        height: result.info.height,
        format: result.info.format
      };

      statusEl.textContent = "Upload complete ✅";
      urlEl.textContent = uploadedImage.url;

      console.log("Uploaded image:", uploadedImage);

      // ✅ STEP 2 — IMAGE QUALITY CHECK
const minSize = 1200;
const shortestSide = Math.min(uploadedImage.width, uploadedImage.height);
const qualityEl = document.getElementById("imageQualityWarning");

if (shortestSide < minSize) {
  qualityEl.textContent =
    `⚠️ Low resolution (${uploadedImage.width}×${uploadedImage.height}). ` +
    `Minimum is ${minSize}px on the shortest side.`;
  qualityEl.style.color = "#b45309";
} else {
  qualityEl.textContent = "✅ Image resolution looks good for printing.";
  qualityEl.style.color = "#15803d";
}      
  }
    });

    statusEl.textContent = "Open upload window…";
    widget.open();
  }

  // Price updates
  updatePriceUI();
  sizeSelect?.addEventListener("change", updatePriceUI);
  addonMulticolor?.addEventListener("change", updatePriceUI);
  addonCleanup?.addEventListener("change", updatePriceUI);
  addonRush?.addEventListener("change", updatePriceUI);

  document.getElementById("uploadBtn").addEventListener("click", () => {
    openUploadWidget().catch(err => {
      document.getElementById("uploadStatus").textContent = "Error: " + err.message;
    });
  });
  document.getElementById("continueBtn").addEventListener("click", (e) => {
    e.preventDefault();

    if (!uploadedImage?.url) {
      alert("Please upload an image first.");
      return;
    }

    const sizeKey = sizeSelect?.value || "150x150_100";
    const base = BASE_PRICES[sizeKey] ?? 0;
    const addonsObj = selectedAddons();
    const addons = addonsObj.map(a => a.name);
    const total = base + addonsObj.reduce((sum, a) => sum + a.price, 0);

    const draft = {
      imageUrl: uploadedImage.url,
      width: uploadedImage.width,
      height: uploadedImage.height,
      format: uploadedImage.format,
      size: prettySize(sizeKey),
      pieces: parsePieces(sizeKey),
      addons,
      total,
    };

    // Store under BOTH keys for backwards compatibility
    localStorage.setItem("puzzleDraft", JSON.stringify(draft));
    localStorage.setItem("puzzleRequest", JSON.stringify(draft));

    window.location.href = "custom.html";
  });

</script>
</body>
</html>





